syntax = "proto3";

package tools.teal.pulsar.ui.api.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";
import "google/rpc/status.proto";

message TestResult {
  bool is_ok = 1;
  google.protobuf.StringValue error = 2;
}
message ChainTestResult {
  bool is_ok = 1;
  repeated TestResult results = 2;
}

message Message {
  // Message value as raw bytes.
  google.protobuf.BytesValue raw_value = 4;

  // Message value serialized as JSON.
  google.protobuf.StringValue value = 5;

  // The state, accumulated during applying message filters for all messages sequentially.
  // Not a part of Pulsar message.
  google.protobuf.StringValue session_context_state_json = 50;

  // Evaluated message filter code can produce logs or errors.
  // We need to store them in the message to be able to show them in the UI.
  // Both, stdout and stderr are stored in the same field.
  google.protobuf.StringValue debug_stdout = 51;

  google.protobuf.Int32Value session_target_index = 52;
  repeated ChainTestResult session_color_rule_chain_test_results = 53;
  repeated ChainTestResult session_target_color_rule_chain_test_results = 54;
  ChainTestResult session_message_filter_chain_test_result = 55;
  ChainTestResult session_target_message_filter_chain_test_result = 56;

  map<string, string> properties = 1;

  google.protobuf.Int64Value event_time = 7;
  google.protobuf.Int64Value publish_time = 6;
  google.protobuf.Int64Value broker_publish_time = 22;

  google.protobuf.BytesValue message_id = 30;
  google.protobuf.Int64Value sequence_id = 8;
  google.protobuf.StringValue producer_name = 9;
  google.protobuf.StringValue key = 10;
  google.protobuf.BytesValue ordering_key = 11;
  google.protobuf.StringValue topic = 12;
  google.protobuf.Int32Value redelivery_count = 13;
  google.protobuf.Int64Value schema_version = 14;
  google.protobuf.Int32Value size = 15;

  google.protobuf.BoolValue is_replicated = 20;
  google.protobuf.StringValue replicated_from = 21;
}

enum SubscriptionMode {
  SUBSCRIPTION_MODE_UNSPECIFIED = 0;
  SUBSCRIPTION_MODE_DURABLE = 1;
  SUBSCRIPTION_MODE_NON_DURABLE = 2;
}

enum SubscriptionType {
  SUBSCRIPTION_TYPE_UNSPECIFIED = 0;
  SUBSCRIPTION_TYPE_EXCLUSIVE = 1;
  SUBSCRIPTION_TYPE_FAILOVER = 2;
  SUBSCRIPTION_TYPE_SHARED = 3;
  SUBSCRIPTION_TYPE_KEY_SHARED = 4;
}

enum DateTimeUnit {
  DATE_TIME_UNIT_UNSPECIFIED = 0;
  DATE_TIME_UNIT_YEAR = 1;
  DATE_TIME_UNIT_MONTH = 2;
  DATE_TIME_UNIT_WEEK = 3;
  DATE_TIME_UNIT_DAY = 4;
  DATE_TIME_UNIT_HOUR = 5;
  DATE_TIME_UNIT_MINUTE = 6;
  DATE_TIME_UNIT_SECOND = 7;
}

message EarliestMessage {}
message LatestMessage {}

message NthMessageBeforeLatest {
  int64 n = 1;
}

message NthMessageAfterEarliest {
  int64 n = 1;
}

message MessageId {
  bytes message_id = 1;
}

message DateTime {
  google.protobuf.Timestamp date_time = 1;
}

message RelativeDateTime {
  int32 value = 1;
  DateTimeUnit unit = 2;
  bool is_rounded_to_unit_start = 3;
}

message ConsumerSessionStartFrom {
  oneof start_from {
    EarliestMessage start_from_earliest_message = 1;
    LatestMessage start_from_latest_message = 2;
    NthMessageAfterEarliest start_from_nth_message_after_earliest = 6;
    NthMessageBeforeLatest start_from_nth_message_before_latest = 7;
    MessageId start_from_message_id = 3;
    DateTime start_from_date_time = 4;
    RelativeDateTime start_from_relative_date_time = 5;
  }
}

message ConsumerSessionEventMessagesProcessed {
  int64 message_count = 1;
}

message ConsumerSessionEventMessagesDelivered {
  int64 message_count = 1;
}

message ConsumerSessionEventBytesProcessed {
  int64 byte_count = 1;
}

message ConsumerSessionEventBytesDelivered {
  int64 byte_count = 1;
}

message ConsumerSessionEventMessageDecodeFailed {
  int64 fail_count = 1;
}

message ConsumerSessionEventTimeElapsed {
  int64 time_elapsed_ms = 1;
}

message ConsumerSessionEventTopicEndReached {}

message ConsumerSessionEventUnexpectedErrorOccurred {}

message ConsumerSessionEventMessageId {
  MessageId message_id = 1;
}

message ConsumerSessionEvent {
  oneof event {
    ConsumerSessionEventMessagesProcessed event_messages_processed = 1;
    ConsumerSessionEventMessagesDelivered event_messages_delivered = 2;
    ConsumerSessionEventBytesProcessed event_bytes_processed = 3;
    ConsumerSessionEventBytesDelivered event_bytes_delivered = 4;
    ConsumerSessionEventMessageDecodeFailed event_message_decode_failed = 5;
    ConsumerSessionEventTimeElapsed event_time_elapsed = 6;
    ConsumerSessionEventTopicEndReached event_topic_end_reached = 7;
    ConsumerSessionEventUnexpectedErrorOccurred event_unexpected_error_occurred = 8;
    ConsumerSessionEventMessageId event_message_id = 9;
  }
}

enum ConsumerSessionPauseTriggerChainMode {
  CONSUMER_SESSION_PAUSE_TRIGGER_CHAIN_MODE_UNSPECIFIED = 0;
  CONSUMER_SESSION_PAUSE_TRIGGER_CHAIN_MODE_ALL = 1;
  CONSUMER_SESSION_PAUSE_TRIGGER_CHAIN_MODE_ANY = 2;
}

message ConsumerSessionPauseTriggerChain {
  repeated ConsumerSessionEvent events = 1;
  ConsumerSessionPauseTriggerChainMode mode = 2;
}

message ColoringRule {
  bool is_enabled = 4;
  MessageFilterChain message_filter_chain = 1;
  string foreground_color = 2;
  string background_color = 3;
}

message ColoringRuleChain {
  bool is_enabled = 2;
  repeated ColoringRule coloring_rules = 1;
}

message MultiTopicSelector {
  repeated string topic_fqns = 1;
}

enum RegexSubscriptionMode {
  REGEX_SUBSCRIPTION_MODE_UNSPECIFIED = 0;
  REGEX_SUBSCRIPTION_MODE_PERSISTENT_ONLY = 1;
  REGEX_SUBSCRIPTION_MODE_NON_PERSISTENT_ONLY = 2;
  REGEX_SUBSCRIPTION_MODE_ALL_TOPICS = 3;
}

message NamespacedRegexTopicSelector {
  string namespace_fqn = 1;
  string pattern = 2;
  RegexSubscriptionMode regex_subscription_mode = 3;
}

message TopicSelector {
  oneof topic_selector {
    MultiTopicSelector multi_topic_selector = 1;
    NamespacedRegexTopicSelector namespaced_regex_topic_selector = 2;
  }
}

message ConsumerSessionTarget {
  TopicSelector topic_selector = 1;
  MessageFilterChain message_filter_chain = 2;
  ColoringRuleChain coloring_rule_chain = 3;
}

message ConsumerSessionConfig {
  ConsumerSessionStartFrom start_from = 1;
  repeated ConsumerSessionTarget targets = 2;
  MessageFilterChain message_filter_chain = 3;
  ConsumerSessionPauseTriggerChain pause_trigger_chain = 4;
  ColoringRuleChain coloring_rule_chain = 5;
}

message CreateConsumerRequest {
  string consumer_name = 1;
  ConsumerSessionConfig consumer_session_config = 2;
}

message CreateConsumerResponse {
  google.rpc.Status status = 1;
}

message DeleteConsumerRequest {
  string consumer_name = 1;
}

message DeleteConsumerResponse {
  google.rpc.Status status = 1;
}

message JsMessageFilter {
  string js_code = 1;
}

message TestOpIsNull {}

message TestOpIsDefined {}

message TestOpBoolEquals {
  bool equals = 1;
}

message TestOpNumberEquals {
  string equals = 1; // Number encoded as a string. Having "." char means float number.
}

message TestOpNumberLt {
  string lt = 1; // Number encoded as a string. Having "." char means float number.
}

message TestOpNumberLte {
  string lte = 1; // Number encoded as a string. Having "." char means float number.
}

message TestOpNumberGt {
  string gt = 1; // Number encoded as a string. Having "." char means float number.
}

message TestOpNumberGte {
  string gte = 1; // Number encoded as a string. Having "." char means float number.
}

message TestOpStringEquals {
  string equals = 1;
}

message TestOpStringIncludes {
  string includes = 1;
  bool is_case_sensitive = 2;
}

message TestOpStartsWith {
  string starts_with = 1;
  bool is_case_sensitive = 2;
}

message TestOpStringEndsWith {
  string ends_with = 1;
  bool is_case_sensitive = 3;
}

message TestOpStringMatchesRegex {
  string regexp = 1;
}

message TestOpArrayContains {
  AnyTestOp test_item_op = 1;
  NumberTestOp matched_items_count_compare_op = 2;
  int32 matched_items_count_compare_num = 2;
}

message TestOpArraySize {
  NumberTestOp op = 1;
}

message TestOpArrayAny {
  AnyTestOp op = 1;
}

message TestOpArrayAll {
  AnyTestOp op = 1;
}

message TestOpObjectAnyKey {
  StringTestOp op = 1;
}

message TestOpObjectAllKeys {
  StringTestOp op = 1;
}

message TestOpObjectAnyValue {
  AnyTestOp op = 1;
}

message TestOpObjectAllValues {
}

message TestOpObjectValueByKey {
  string key = 1;
  AnyTestOp op = 2;
}

message TestOpObjectSize {
  NumberTestOp op = 1;
}

message AnyBoolTestOp {
  oneof op {
    TestOpBoolEquals op_bool_equals = 1;
  }
}

message AnyArrayTestOp {
  oneof op {
    TestOpArrayContains op_array_contains = 1;
    TestOpArraySize op_array_size = 2;
    TestOpArrayEvery op_array_every = 3;
    TestOpArrayAny op_array_any = 4;
    TestOpArrayAll op_array_all = 5;
  }
}

message AnyObjectTestOp {
  oneof op {
    TestOpObjectAnyKey op_object_any_key = 1;
    TestOpObjectAllKeys op_object_all_keys = 2;
    TestOpObjectAnyValue op_object_any_value = 3;
    TestOpObjectAllValue op_object_all_values = 4;
    TestOpObjectValueByKey op_object_value_by_key = 5;
    TestOpObjectHasValueAtKey op_object_has_value_at_key = 6;
    TestOpObjectSize op_object_size = 7;
  }
}

message AnyNumberTestOp {
  oneof op {
    TestOpNumberEquals op_number_equals = 2;
    TestOpNumberLt op_number_lt = 3;
    TestOpNumberLte op_number_lte = 4;
    TestOpNumberGt op_number_gt = 5;
    TestOpNumberGte op_number_gte = 6;
  }
}

message AnyStringTestOp {
  TestOpStringEquals op_string_equals = 7;
  TestOpStringIncludes op_string_includes = 8;
  TestOpStartsWith op_string_starts_with = 9;
  TestOpStringEndsWith op_string_ends_with = 10;
  TestOpStringMatchesRegex op_string_matches_regex = 11;
}

message AnyTestOp {
  oneof op {
    TestOpIsDefined op_is_defined = 1;
    TestOpIsNull op_is_null = 2;
    AnyBoolTestOp op_any_bool = 3;
    AnyObjectTestOp op_any_object = 4;
    AnyStringTestOp op_any_string = 5;
    AnyNumberTestOp op_any_number = 6;
  }
}

message BasicMessageFilterKeyTarget {
  google.protobuf.StringValue json_field_selector = 1; // in a jq-like form: ".obj.nestedObj.field"
}

message BasicMessageFilterValueTarget {
  google.protobuf.StringValue json_field_selector = 1; // in a jq-like form: ".obj.nestedObj.field"
}

message BasicMessageFilterPropertyTarget {
  string property_key = 1;
}

message BasicMessageFilterSessionContextStateTarget {
  google.protobuf.StringValue json_field_selector = 1; // in a jq-like form: ".obj.nestedObj.field"
}

message BasicMessageFilterTarget {
  BASIC_MESSAGE_FILTER_TARGET_UNSPECIFIED = 0;
  BASIC_MESSAGE_FILTER_TARGET_KEY = 1;
  BASIC_MESSAGE_FILTER_TARGET_VALUE = 2;
  BASIC_MESSAGE_FILTER_TARGET_PROPERTIES = 3;
  BASIC_MESSAGE_FILTER_TARGET_SESSION_CONTEXT_STATE = 4;
}

message JsonFieldSelector {
  string json_field_selector = 1; // in a jq-like form: ".obj.nestedObj.field"
}

message BasicMessageFilter {
  BasicMessageFilterTarget target = 1;

  oneof operation {
    BasicMessageFilterOperationContains contains = 10;
    BasicMessageFilterOperationEquals equals = 11;
    BasicMessageFilterOperationStartsWith starts_with = 12;
    BasicMessageFilterOperationEndsWith ends_with = 13;
    BasicMessageFilterOperationRegex regex = 14;
    BasicMessageFilterOperationGreaterThan greater_than = 15;
    BasicMessageFilterOperationGreaterThanOrEquals greater_than_or_equals = 16;
    BasicMessageFilterOperationLessThan less_than = 17;
    BasicMessageFilterOperationLessThanOrEquals less_than_or_equals = 18;
    BasicMessageFilterOperationIsNull is_null = 20;
  }
}

message MessageFilter {
  bool is_enabled = 10;
  bool is_negated = 11;
  oneof filter {
    JsMessageFilter filter_js = 1;
    BasicMessageFilter filter_basic = 2;
  }
}

enum MessageFilterChainMode {
  MESSAGE_FILTER_CHAIN_MODE_UNSPECIFIED = 0;
  MESSAGE_FILTER_CHAIN_MODE_ALL = 1;
  MESSAGE_FILTER_CHAIN_MODE_ANY = 2;
}

message MessageFilterChain {
  bool is_enabled = 10;
  bool is_negated = 11;
  repeated MessageFilter filters = 1;
  MessageFilterChainMode mode = 2;
}

message ResumeRequest {
  string consumer_name = 1;
  bool include_consumer_stats = 2;
}

message ConsumerStats {}

message ResumeResponse {
  optional google.rpc.Status status = 1;
  repeated Message messages = 2;
  int64 processed_messages = 3;
  optional ConsumerStats consumer_stats = 4;
}

message PauseRequest {
  string consumer_name = 1;
}

message PauseResponse {
  google.rpc.Status status = 1;
}

message RunCodeRequest {
  string consumer_name = 1;
  string code = 2;
}

message RunCodeResponse {
  google.rpc.Status status = 1;
  google.protobuf.StringValue result = 2;
}

message ResolveTopicSelectorRequest {
  TopicSelector topic_selector = 1;
}
message ResolveTopicSelectorResponse {
  google.rpc.Status status = 1;
  repeated string topic_fqns = 2;
}

service ConsumerService {
  rpc CreateConsumer(CreateConsumerRequest) returns (CreateConsumerResponse);
  rpc DeleteConsumer(DeleteConsumerRequest) returns (DeleteConsumerResponse);
  rpc Resume(ResumeRequest) returns (stream ResumeResponse);
  rpc Pause(PauseRequest) returns (PauseResponse);
  rpc RunCode(RunCodeRequest) returns (RunCodeResponse);
  rpc ResolveTopicSelector(ResolveTopicSelectorRequest) returns (ResolveTopicSelectorResponse);
}
