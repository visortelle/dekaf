syntax = "proto3";

package tools.teal.pulsar.ui.topic.v1;

import "google/protobuf/wrappers.proto";
import "google/rpc/status.proto";

enum TopicDomain {
  TOPIC_DOMAIN_UNSPECIFIED = 0;
  TOPIC_DOMAIN_PERSISTENT = 1;
  TOPIC_DOMAIN_NON_PERSISTENT = 2;
}

message ListTopicsRequest {
  string namespace = 1;
  TopicDomain topic_domain = 2;
}
message ListTopicsResponse {
  google.rpc.Status status = 1;
  repeated string topics = 2;
}

message PartitionedTopicMetadata {
  google.protobuf.Int32Value partitions = 1;
  map<string, string> properties = 2;
  google.protobuf.BoolValue deleted = 3;
}

message PartitionedTopicInternalStats {
  PartitionedTopicMetadata metadata = 1;
  map<string, PersistentTopicInternalStats> partitions = 2;
}

message PersistentTopicInternalStats {
  ManagedLedgerInternalStats managed_ledger_internal_stats = 1;
  repeated LedgerInfo schema_ledgers = 2;
  LedgerInfo compacted_ledger = 3;
}

message ManagedLedgerInternalStats {
  google.protobuf.Int64Value entries_added_counter = 1;
  google.protobuf.Int64Value number_of_entries = 2;
  google.protobuf.Int64Value total_size = 3;
  google.protobuf.Int64Value current_ledger_entries = 4;
  google.protobuf.Int64Value current_ledger_size = 5;
  google.protobuf.StringValue last_ledger_created_timestamp = 6;
  google.protobuf.StringValue last_ledger_creation_failure_timestamp = 7;
  google.protobuf.Int32Value waiting_cursors_count = 8;
  google.protobuf.Int32Value pending_entries_count = 9;
  google.protobuf.StringValue last_confirmed_entry = 10;
  google.protobuf.StringValue state = 11;
  repeated LedgerInfo ledgers = 12;
  map<string, CursorStats> cursors = 13;
}

message LedgerInfo {
  google.protobuf.Int64Value ledger_id = 1;
  google.protobuf.Int64Value entries = 2;
  google.protobuf.Int64Value size = 3;
  google.protobuf.BoolValue offloaded = 4;
  google.protobuf.StringValue metadata = 5;
  google.protobuf.BoolValue under_replicated = 6;
}

message CursorStats {
  google.protobuf.StringValue mark_delete_position = 1;
  google.protobuf.StringValue read_position = 2;
  google.protobuf.BoolValue waiting_read_op = 3;
  google.protobuf.Int32Value pending_read_ops = 4;
  google.protobuf.Int64Value messages_consumed_counter = 5;
  google.protobuf.Int64Value cursor_ledger = 6;
  google.protobuf.Int64Value cursor_ledger_last_entry = 7;
  google.protobuf.StringValue individually_deleted_messages = 8;
  google.protobuf.StringValue last_ledger_switch_timestamp = 9;
  google.protobuf.StringValue state = 10;
  google.protobuf.Int64Value number_of_entries_since_first_not_acked_message = 11;
  google.protobuf.Int32Value total_non_contiguous_deleted_messages_range = 12;
  google.protobuf.BoolValue subscription_have_pending_read = 13;
  google.protobuf.BoolValue subscription_have_pending_replay_read = 14;
  map<string, int64> properties = 15;
}

message TopicInternalStats {
  oneof stats {
    PersistentTopicInternalStats topic_stats = 2;
    PartitionedTopicInternalStats partitioned_topic_stats = 3;
  }
}

message GetTopicsInternalStatsRequest {
  repeated string topics = 1;
}

message GetTopicsInternalStatsResponse {
  google.rpc.Status status = 1;
  map<string, TopicInternalStats> stats = 2;
}

message CreatePartitionedTopicRequest {
  string topic = 1;
  map<string, string> properties = 2;
  int32 num_partitions = 3;
}

message CreatePartitionedTopicResponse {
  google.rpc.Status status = 1;
}

message CreateNonPartitionedTopicRequest {
  string topic = 1;
  map<string, string> properties = 2;
}

message CreateNonPartitionedTopicResponse {
  google.rpc.Status status = 1;
}

message DeleteTopicRequest {
  string topic_name = 1;
  bool force = 2;
}

message DeleteTopicResponse {
  google.rpc.Status status = 1;
}

// Stats

enum ProducerAccessMode {
  PRODUCER_ACCESS_MODE_UNSPECIFIED = 0;
  PRODUCER_ACCESS_MODE_SHARED = 1;
  PRODUCER_ACCESS_MODE_EXCLUSIVE = 2;
  PRODUCER_ACCESS_MODE_EXCLUSIVE_WITH_FENCING = 3;
  PRODUCER_ACCESS_MODE_WAIT_FOR_EXCLUSIVE = 4;
}

message PublisherStats {
  ProducerAccessMode access_mode = 1;
  google.protobuf.DoubleValue msg_rate_in = 2;
  google.protobuf.DoubleValue msg_throughput_in = 3;
  google.protobuf.DoubleValue average_msg_size = 4;
  google.protobuf.DoubleValue chunked_message_rate = 5;
  google.protobuf.Int64Value producer_id = 6;
  google.protobuf.BoolValue is_supports_partial_producer = 7;
  google.protobuf.StringValue producer_name = 8;
  google.protobuf.StringValue address = 9;
  google.protobuf.StringValue connected_since = 10;
  google.protobuf.StringValue client_version = 11;
  map<string, string> metadata = 12;
}

message ConsumerStats {
  google.protobuf.DoubleValue msg_rate_out = 1;
  google.protobuf.DoubleValue msg_throughput_out = 2;
  google.protobuf.Int64Value bytes_out_counter = 3;
  google.protobuf.Int64Value msg_out_counter = 4;
  google.protobuf.DoubleValue msg_rate_redeliver = 5;
  google.protobuf.DoubleValue message_ack_rate = 6;
  google.protobuf.DoubleValue chunked_message_rate = 7;
  google.protobuf.StringValue consumer_name = 8;
  google.protobuf.Int32Value available_permits = 9;
  google.protobuf.Int32Value unacked_messages = 10;
  google.protobuf.Int32Value avg_messages_per_entry = 11;
  google.protobuf.BoolValue is_blocked_consumer_on_unacked_msgs = 12;
  google.protobuf.StringValue read_position_when_joining = 13;
  google.protobuf.StringValue address = 14;
  google.protobuf.StringValue connected_since = 15;
  google.protobuf.StringValue client_version = 16;
  google.protobuf.Int64Value last_acked_timestamp = 17;
  google.protobuf.Int64Value last_consumed_timestamp = 18;
  google.protobuf.Int64Value last_consumed_flow_timestamp = 19;
  repeated google.protobuf.StringValue key_hash_ranges = 20;
  map<string, string> metadata = 21;
}

message SubscriptionStats {
  google.protobuf.DoubleValue msg_rate_out = 1;
  google.protobuf.DoubleValue msg_throughput_out = 2;
  google.protobuf.Int64Value bytes_out_counter = 3;
  google.protobuf.Int64Value msg_out_counter = 4;
  google.protobuf.DoubleValue msg_rate_redeliver = 5;
  google.protobuf.DoubleValue message_ack_rate = 6;
  google.protobuf.Int32Value chunked_message_rate = 7;
  google.protobuf.Int64Value msg_backlog = 8;
  google.protobuf.Int64Value backlog_size = 9;
  google.protobuf.Int64Value earliest_msg_publish_time_in_backlog = 10;
  google.protobuf.Int64Value msg_backlog_no_delayed = 11;
  google.protobuf.BoolValue is_blocked_subscription_on_unacked_msgs = 12;
  google.protobuf.Int64Value msg_delayed = 13;
  google.protobuf.Int64Value unacked_messages = 14;
  google.protobuf.StringValue type = 15;
  google.protobuf.StringValue active_consumer_name = 16;
  google.protobuf.DoubleValue msg_rate_expired = 17;
  google.protobuf.Int64Value total_msg_expired = 18;
  google.protobuf.Int64Value last_expire_timestamp = 19;
  google.protobuf.Int64Value last_consumed_flow_timestamp = 20;
  google.protobuf.Int64Value last_consumed_timestamp = 21;
  google.protobuf.Int64Value last_acked_timestamp = 22;
  google.protobuf.Int64Value last_mark_delete_advanced_timestamp = 23;
  repeated ConsumerStats consumers = 24;
  google.protobuf.BoolValue is_durable = 25;
  google.protobuf.BoolValue is_replicated = 26;
  google.protobuf.BoolValue is_allow_out_of_order_delivery = 27;
  google.protobuf.StringValue key_shared_mode = 28;
  map<string, string> consumers_after_mark_delete_position = 29;
  map<string, string> subscription_properties = 30;
  google.protobuf.Int32Value non_contiguous_deleted_messages_ranges = 31;
  google.protobuf.Int32Value non_contiguous_deleted_messages_ranges_serialized_size = 32;
  google.protobuf.Int64Value filter_processed_msg_count = 33;
  google.protobuf.Int64Value filter_accepted_msg_count = 34;
  google.protobuf.Int64Value filter_rejected_msg_count = 35;
  google.protobuf.Int64Value filter_rescheduled_msg_count = 36;
  google.protobuf.Int64Value delayed_message_index_size_in_bytes = 37;
}

message ReplicatorStats {
  google.protobuf.DoubleValue msg_rate_in = 1;
  google.protobuf.DoubleValue msg_throughput_in = 2;
  google.protobuf.DoubleValue msg_rate_out = 3;
  google.protobuf.DoubleValue msg_throughput_out = 4;
  google.protobuf.DoubleValue msg_rate_expired = 5;
  google.protobuf.Int64Value replication_backlog = 6;
  google.protobuf.BoolValue is_connected = 7;
  google.protobuf.Int64Value replication_deley_in_seconds = 8;
  google.protobuf.StringValue inbound_connection = 9;
  google.protobuf.StringValue inbound_connected_since = 10;
  google.protobuf.StringValue outbound_connection = 11;
  google.protobuf.StringValue outbound_connected_since = 12;
}

message CompactionStats {
  google.protobuf.Int64Value last_compaction_removed_event_count = 1;
  google.protobuf.Int64Value last_compaction_succeed_timestamp = 2;
  google.protobuf.Int64Value last_compaction_failed_timestamp = 3;
  google.protobuf.Int64Value last_compaction_duration_time_in_mills = 4;
}

message TopicStats {
  google.protobuf.DoubleValue msg_rate_in = 1;
  google.protobuf.DoubleValue msg_throughput_in = 2;
  google.protobuf.DoubleValue msg_rate_out = 3;
  google.protobuf.DoubleValue msg_throughput_out = 4;
  google.protobuf.Int64Value bytes_in_counter = 5;
  google.protobuf.Int64Value msg_in_counter = 6;
  google.protobuf.Int64Value bytes_out_counter = 7;
  google.protobuf.Int64Value msg_out_counter = 8;
  google.protobuf.DoubleValue average_msg_size = 9;
  google.protobuf.BoolValue is_msg_chunk_published = 10;
  google.protobuf.Int64Value storage_size = 11;
  google.protobuf.Int64Value backlog_size = 12;
  google.protobuf.Int64Value earliest_msg_publish_time_in_backlogs = 13;
  google.protobuf.Int64Value offloaded_storage_size = 14;
  repeated PublisherStats publishers = 15;
  google.protobuf.Int32Value waiting_publishers = 16;
  map<string, SubscriptionStats> subscriptions = 17;
  map<string, ReplicatorStats> replication = 18;
  google.protobuf.StringValue deduplication_status = 19;
  google.protobuf.Int64Value topic_epoch = 20;
  google.protobuf.Int32Value non_contiguous_deleted_messages_ranges = 21;
  google.protobuf.Int32Value non_contiguous_deleted_messages_ranges_serialized_size = 22;
  CompactionStats compaction = 23;
  google.protobuf.StringValue owner_broker = 24;
  google.protobuf.Int64Value delayed_message_index_size_in_bytes = 25;
}

message PartitionedTopicStats {
  TopicStats stats = 1;
  PartitionedTopicMetadata metadata = 2;
  map<string, TopicStats> partitions = 3;
}

message GetTopicsStatsRequest {
  repeated string topics = 1;
  repeated string partitioned_topics = 2;
  bool is_get_precise_backlog = 3;
  bool is_per_partition = 4;
  bool is_subscription_backlog_size = 5;
  bool is_earliest_time_in_backlog = 6;
}
message GetTopicsStatsResponse {
  google.rpc.Status status = 1;
  map<string, TopicStats> topic_stats = 2;
  map<string, PartitionedTopicStats> partitioned_topic_stats = 3;
}

service TopicService {
  rpc CreatePartitionedTopic(CreatePartitionedTopicRequest) returns (CreatePartitionedTopicResponse);
  rpc CreateNonPartitionedTopic(CreateNonPartitionedTopicRequest) returns (CreateNonPartitionedTopicResponse);
  rpc GetTopicsInternalStats(GetTopicsInternalStatsRequest) returns (GetTopicsInternalStatsResponse);
  rpc ListTopics(ListTopicsRequest) returns (ListTopicsResponse);
  rpc DeleteTopic(DeleteTopicRequest) returns (DeleteTopicResponse) {}
  rpc GetTopicsStats(GetTopicsStatsRequest) returns (GetTopicsStatsResponse);
}
